<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Court: è«–ç ´ãƒãƒˆãƒ« V30 (Stable Fix)</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 20, 0.95);
            --text-color: #eee;
            --neon-cyan: #00ffd5;   
            --neon-pink: #ff0055;   
            --neon-yellow: #f4d03f; 
            --neon-blue: #2979ff;
            --border-color: rgba(255, 255, 255, 0.15);
            --gray-disabled: #666;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; margin: 0; overflow: hidden;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)),
                url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
        }

        /* è¿”å›æŒ‰é’® */
        #back-btn {
            position: fixed; top: 20px; left: 20px; z-index: 3000;
            text-decoration: none; color: var(--neon-cyan); font-weight: 800; font-size: 14px;
            padding: 10px 20px; border: 1px solid var(--neon-cyan);
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
            border-radius: 4px; display: flex; align-items: center; gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 213, 0.1);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }
        #back-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); transform: translateX(5px); }

        .screen {
            width: 1100px; height: 95vh;
            background-color: var(--panel-bg);
            border: 2px solid var(--border-color);
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            display: none; flex-direction: row; 
            position: relative; overflow: hidden;
            backdrop-filter: blur(10px);
            border-radius: 4px;
        }
        .screen.active { display: flex; animation: slideIn 0.5s cubic-bezier(0.23, 1, 0.32, 1); }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* å·¦ä¾§ä¸»åŒºåŸŸ */
        .main-area {
            flex: 1; display: flex; flex-direction: column;
            padding: 20px; border-right: 2px solid #333; position: relative;
        }

        /* å³ä¾§è¯ç‰©æ  */
        .sidebar {
            width: 260px; background: rgba(0, 10, 20, 0.6);
            padding: 15px; display: flex; flex-direction: column; gap: 15px;
            border-left: 1px solid var(--neon-cyan);
            box-shadow: inset 10px 0 20px rgba(0,0,0,0.5);
            z-index: 20;
        }
        
        .sidebar-title {
            color: var(--neon-cyan); font-size: 1.1em; font-weight: 900;
            text-transform: uppercase; text-align: center;
            border-bottom: 2px solid var(--neon-cyan); padding-bottom: 10px;
            letter-spacing: 2px; text-shadow: 0 0 10px var(--neon-cyan);
        }
        .sidebar-subtitle {
            font-size: 0.8em; color: #888; text-align: center; margin-top: -10px;
        }

        #evidence-list {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }
        #evidence-list::-webkit-scrollbar { width: 4px; }
        #evidence-list::-webkit-scrollbar-thumb { background: var(--neon-cyan); }

        .evidence-item {
            background: rgba(0, 20, 30, 0.8); border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 12px; font-size: 0.9em;
            cursor: pointer; transition: 0.2s; position: relative;
            animation: flashIn 0.4s ease-out; font-family: monospace;
            border-left: 4px solid var(--neon-blue);
            word-break: break-all;
        }
        @keyframes flashIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .evidence-item:hover { background: var(--neon-blue); color: #000; transform: translateX(-5px); }
        .evidence-item:active { transform: scale(0.98); }

        /* Tooltip (é€šç”¨) */
        .evidence-tooltip {
            position: absolute; background: rgba(0, 0, 0, 0.98);
            border: 1px solid var(--neon-blue); color: #fff; padding: 15px;
            border-radius: 4px; font-size: 0.9em; max-width: 350px;
            z-index: 2000; pointer-events: none; display: none;
            box-shadow: 0 0 25px rgba(41, 121, 255, 0.5);
            white-space: pre-wrap; font-family: 'Courier New', monospace; line-height: 1.6;
        }
        .evidence-tooltip strong { display: block; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 3px; font-size: 1.1em; letter-spacing: 1px;}
        
        /* è®ºç ´è§£é‡Šçš„ç‰¹æ®Šæ ·å¼ */
        .evidence-tooltip.logic-break {
            border-color: var(--neon-yellow);
            box-shadow: 0 0 25px rgba(244, 208, 63, 0.5);
        }
        .evidence-tooltip.logic-break strong { color: var(--neon-yellow); }
        .evidence-tooltip hr { border: 0; border-top: 1px dashed #444; margin: 10px 0; }

        /* Developer Button */
        #dev-trigger {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255, 0, 0, 0.2); border: 2px solid #fff;
            color: #fff; font-size: 24px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 9999; transition: 0.3s;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #dev-trigger:hover { background: rgba(255, 0, 0, 0.8); transform: scale(1.1); }

        #dev-console {
            position: fixed; top: 0; right: 0; height: 100vh; width: 450px;
            background: rgba(0,0,0,0.95); border-left: 2px solid #0f0;
            padding: 20px; box-sizing: border-box;
            display: none; flex-direction: column;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px; color: #0f0;
            z-index: 9998; overflow-y: auto;
        }
        #dev-console.open { display: flex; }
        .log-entry { margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 10px; word-wrap: break-word; white-space: pre-wrap; }
        .dev-btn { background:#000; color:#0f0; border:1px solid #0f0; cursor:pointer; padding: 2px 8px; margin-left: 5px; }
        .dev-btn:hover { background: #0f0; color: #000; }

        /* Start & Config */
        #start-screen, #config-screen { 
            flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; gap: 20px; width: 100%; z-index: 10;
        }

        h1 { font-size: 5em; color: var(--neon-cyan); text-shadow: 0 0 20px var(--neon-cyan); margin: 0; font-style: italic; letter-spacing: -3px; line-height: 1;}
        
        .big-btn { 
            padding: 15px 50px; font-size: 1.2em; 
            background: transparent; color: var(--neon-cyan); 
            border: 2px solid var(--neon-cyan); 
            cursor: pointer; font-weight: 900; transition: 0.2s; 
            text-transform: uppercase; letter-spacing: 2px;
            clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
        }
        .big-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 30px var(--neon-cyan); }
        
        .cyber-input { padding: 15px; width: 400px; background: rgba(0,0,0,0.5); border: 1px solid #555; color: #fff; outline: none; text-align: center; font-size: 1.1em; }
        .cyber-input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 255, 213, 0.3); }

        /* Status Bar */
        #status-bar { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .hp-box { width: 45%; }
        .role-info { display: flex; align-items: center; font-size: 1.4em; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .role-emoji { font-size: 1.5em; margin: 0 10px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
        
        .hp-bar-bg { width: 100%; height: 12px; background: #222; overflow: hidden; border: 1px solid #555; transform: skewX(-20deg); }
        .hp-bar-fill { height: 100%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #enemy-hp-bar { background: linear-gradient(90deg, var(--neon-pink), #ff8a80); box-shadow: 0 0 10px var(--neon-pink); }
        #hero-hp-bar { background: linear-gradient(90deg, var(--neon-cyan), #80d8ff); float: right; box-shadow: 0 0 10px var(--neon-cyan); }

        /* Chat Log */
        #chat-log { 
            flex-grow: 1; overflow-y: auto; padding-right: 10px; 
            display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth;
        }
        #chat-log::-webkit-scrollbar { width: 6px; }
        #chat-log::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        .narrative-box {
            background: rgba(0, 20, 40, 0.4); border-left: 4px solid var(--neon-blue);
            padding: 20px; color: #ccc; font-size: 1em; line-height: 1.7;
            margin: 10px 0; font-family: monospace;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        /* ç»“å±€å¤ç›˜çš„ç‰¹æ®Šæ ·å¼ */
        .narrative-box.final {
            border-left: 4px solid var(--neon-yellow);
            background: rgba(40, 30, 0, 0.7);
            color: #fff;
            box-shadow: 0 0 20px rgba(244, 208, 63, 0.2);
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }
        .narrative-box.final .narrative-label { color: var(--neon-yellow); }

        .narrative-label { 
            color: var(--neon-blue); font-weight: bold; font-size: 0.8em; 
            display: block; margin-bottom: 8px; letter-spacing: 2px;
            border-bottom: 1px solid rgba(41, 121, 255, 0.3); padding-bottom: 5px;
        }

        .bubble-row { display: flex; gap: 20px; max-width: 95%; margin-bottom: 10px; animation: popIn 0.3s; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .bubble-avatar { font-size: 2.5em; line-height: 1; min-width: 50px; text-align: center; }
        .chat-bubble { 
            padding: 18px 25px; line-height: 1.6; color: #fff; position: relative; font-size: 1.05em;
            background: #1a1a1a; border: 1px solid #444; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .bubble-row.enemy { align-self: flex-start; }
        .bubble-row.enemy .chat-bubble { 
            border-top: 3px solid var(--neon-pink); border-radius: 0 20px 20px 20px; 
            background: linear-gradient(135deg, #1a050a 0%, #111 100%);
        }
        
        .bubble-row.hero { align-self: flex-end; flex-direction: row-reverse; }
        .bubble-row.hero .chat-bubble { 
            border-top: 3px solid var(--neon-cyan); border-radius: 20px 0 20px 20px; text-align: right; 
            background: linear-gradient(-135deg, #051a1a 0%, #111 100%); color: #ccfffa;
        }

        /* ç ´ç»½ (Statement) */
        .highlight-statement {
            background: linear-gradient(180deg, #ffffff 0%, var(--neon-yellow) 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            font-weight: 900; text-shadow: 0 0 10px rgba(244, 208, 63, 0.4);
            font-size: 1.15em; border-bottom: 2px dashed rgba(244, 208, 63, 0.5); padding-bottom: 2px;
            transition: all 0.5s ease; cursor: help;
        }
        .highlight-statement.resolved {
            background: none; -webkit-background-clip: initial; color: var(--gray-disabled);
            text-shadow: none; border-bottom: none; text-decoration: line-through;
            font-weight: normal; font-size: 1em; cursor: help;
        }

        /* è¯æ® (Evidence) */
        .highlight-evidence {
            color: var(--neon-blue); font-weight: bold; cursor: pointer;
            border: 1px solid var(--neon-blue); padding: 2px 6px; border-radius: 4px;
            background: rgba(41, 121, 255, 0.1); transition: 0.3s;
            display: inline-block; margin: 0 2px;
        }
        .highlight-evidence:hover { background: var(--neon-blue); color: #fff; box-shadow: 0 0 15px var(--neon-blue); transform: translateY(-2px); }
        .highlight-evidence::after { content: ' âœš'; font-size: 0.8em; opacity: 0.7; }
        
        /* å·²æ”¶é›†çŠ¶æ€ (èƒŒåŒ…é‡Œæœ‰) */
        .highlight-evidence.collected {
            color: #888; border-color: #555; background: transparent; 
            cursor: not-allowed; pointer-events: none; opacity: 0.6;
        }
        .highlight-evidence.collected::after { content: ' (GET)'; opacity: 0.5; color: var(--neon-cyan); }

        /* å·²ä½¿ç”¨çŠ¶æ€ (ç”¨æ‰äº†) */
        .highlight-evidence.used {
            color: var(--gray-disabled); border-color: var(--gray-disabled);
            background: transparent; text-decoration: line-through;
            cursor: not-allowed; pointer-events: none; opacity: 0.4;
        }
        .highlight-evidence.used::after { content: ' âœ”'; opacity: 0.5; }

        #input-area { display: flex; gap: 15px; margin-top: 20px; }
        #player-input { 
            flex: 1; padding: 0 20px; height: 50px; background: rgba(0,0,0,0.5); 
            border: 2px solid #444; color: #fff; outline: none; font-size: 1.1em; transition: 0.3s;
        }
        #player-input:focus { border-color: var(--neon-cyan); background: rgba(0,0,0,0.8); }
        
        #send-btn { 
            background: var(--neon-cyan); border: none; padding: 0 40px; font-weight: 900; 
            cursor: pointer; color: #000; font-size: 1.2em; font-style: italic;
            clip-path: polygon(15% 0, 100% 0, 100% 100%, 0% 100%); transition: 0.3s;
        }
        #send-btn:hover { background: #fff; transform: scale(1.05); }

        #loading-overlay { 
            position: absolute; top:0;left:0;right:0;bottom:0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px); z-index:999; display:none; flex-direction: column; 
            justify-content:center; align-items:center; 
        }
        .loading-text { 
            font-size: 2.5em; color: var(--neon-cyan); font-weight: 900; letter-spacing: 5px; 
            animation: blink 0.8s infinite alternate; text-shadow: 0 0 20px var(--neon-cyan);
        }
        @keyframes blink { from { opacity: 0.4; transform: scale(0.98); } to { opacity: 1; transform: scale(1.02); } }

        .system-msg { text-align: center; color: #666; font-size: 0.9em; margin: 15px 0; letter-spacing: 2px; text-transform: uppercase; }
        
        .fatal-warning {
            color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink);
            font-weight: 900; font-size: 1.1em; animation: shake 0.5s infinite;
        }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, 1px); } }
    </style>
    
    <script type="importmap">{ "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }</script>
</head>
<body>

    <a id="back-btn" href="../index.html">â—€ HOME</a>

    <div id="tooltip" class="evidence-tooltip"></div>

    <div id="dev-trigger" onclick="promptDevMode()">!</div>
    
    <div id="dev-console">
        <div style="border-bottom:1px solid #0f0; margin-bottom:10px; padding-bottom:5px;">
            <strong>>> SYSTEM LOG <<</strong>
            <div style="float:right;">
                <button onclick="downloadDevLog()" class="dev-btn">DL</button>
                <button onclick="clearDevLog()" class="dev-btn">CLR</button>
                <button onclick="closeDevConsole()" class="dev-btn">X</button>
            </div>
        </div>
        <div id="dev-content"></div>
    </div>

    <div id="start-screen" class="screen active">
        <h1>è«–ç ´ BATTLE</h1>
        <p style="color:#aaa; letter-spacing: 4px; margin-bottom: 40px; font-weight: bold;">TRUTH IS HIDDEN IN THE DATA</p>
        <div style="display:flex; gap:20px;">
            <button class="big-btn" onclick="setLanguage('zh')">ä¸­æ–‡ç‰ˆ</button>
            <button class="big-btn" onclick="setLanguage('ja')">æ—¥æœ¬èª</button>
            <button class="big-btn" onclick="setLanguage('en')">English</button>
        </div>
    </div>

    <div id="config-screen" class="screen">
        <h2 data-key="apiTitle" style="color:var(--neon-cyan); font-size: 2em; letter-spacing: 3px;">SYSTEM LINK</h2>
        
        <select id="provider-select" class="cyber-input" onchange="updatePlaceholder()" style="cursor: pointer;">
            <option value="gemini">Google Gemini</option>
            <option value="siliconflow-deepseek">SiliconFlow (DeepSeek V3)</option>
            <option value="siliconflow-qwen">SiliconFlow (Qwen 2.5)</option>
        </select>

        <input type="password" id="api-key-input" class="cyber-input" placeholder="Enter API Key">
        <p id="api-status" style="height:20px; font-weight:bold; letter-spacing: 1px;"></p>
        <button class="big-btn" onclick="verifyAndStart()" data-key="connectBtn">CONNECT</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="main-area">
            <div id="loading-overlay"><div class="loading-text">CALCULATING...</div></div>

            <div id="status-bar">
                <div class="hp-box enemy-theme" style="text-align:left;">
                    <div class="role-info">
                        <span class="role-emoji" id="enemy-emoji">ğŸ˜ˆ</span> 
                        <span id="enemy-name-ui">SUSPECT</span>
                    </div>
                    <div class="hp-bar-bg"><div id="enemy-hp-bar" class="hp-bar-fill" style="width:100%"></div></div>
                    <div style="color:var(--neon-pink); font-size:0.8em; margin-top:5px; font-weight:bold;">MENTAL SHIELD</div>
                </div>
                
                <div class="hp-box hero-theme" style="text-align:right;">
                    <div class="role-info" style="justify-content:flex-end;">
                        <span id="hero-name-ui">DETECTIVE</span> 
                        <span class="role-emoji" id="hero-emoji">ğŸ§</span>
                    </div>
                    <div class="hp-bar-bg"><div id="hero-hp-bar" class="hp-bar-fill" style="width:100%"></div></div>
                    <div style="color:var(--neon-cyan); font-size:0.8em; margin-top:5px; font-weight:bold;">LOGIC DRIVE</div>
                </div>
            </div>

            <div id="chat-log"></div>

            <div id="input-area">
                <input type="text" id="player-input" placeholder="..." autocomplete="off">
                <button id="send-btn" data-key="actionBtn">OBJECTION!</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-title">EVIDENCE FILE</div>
            <div class="sidebar-subtitle">MAX: 7</div>
            <div id="evidence-list">
                <div style="text-align:center; color:#666; font-size:0.8em; margin-top:20px;">NO DATA</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ================= CONFIG & PROMPTS =================
        const i18n = {
            zh: {
                apiTitle: "æ¥å…¥ç¥ç»ç½‘", connectBtn: "è¿æ¥", actionBtn: "è®ºç ´ï¼",
                hero: "è°ƒæŸ¥å‘˜", enemy: "å«Œç–‘äºº",
                welcome: "æ­£åœ¨ä¸‹è½½æ¡ˆä»¶æ¡£æ¡ˆ... å¯»æ‰¾è“è‰²å…³é”®è¯ä½œä¸ºè¯æ®...",
                placeholder: "ç‚¹å‡»å³ä¾§è¯ç‰©ï¼ŒæŒ‡å‡ºå¯¹æ–¹çš„çŸ›ç›¾...",
                retry: "ä¿¡å·ä¸¢å¤±ï¼Œé‡è¿",
                emptyEvidence: "æš‚æ— è¯æ®",
                systemPrompt: `
                ä½ æ˜¯ä¸€ä¸ªã€èµ›åšæœ‹å…‹é£æ ¼é€»è¾‘å¯¹æˆ˜æ¸¸æˆGMã€‘ã€‚
                ã€è¯­è¨€ã€‘è¯·åŠ¡å¿…ä½¿ç”¨ä¸­æ–‡ã€‚
                
                ã€æ¸¸æˆèƒŒæ™¯ï¼šæœ€ç»ˆå®¡åˆ¤ Final Judgmentã€‘
                - åœºæ™¯ï¼šæ³•åº­æœ€ç»ˆå¯¹å†³ã€‚å«Œç–‘äººå·²åœ¨è¢«å‘Šå¸­ã€‚
                - ä»»åŠ¡ï¼šç©å®¶å¿…é¡»ç”¨ç¡®å‡¿çš„è¯æ®ï¼Œå½“åº­å‡»æºƒå«Œç–‘äººçš„è°è¨€ã€‚
                - **é€šä¿—é€»è¾‘**ï¼šç ´ç»½å¿…é¡»æ˜¯æ™®é€šäººä¸€çœ¼èƒ½çœ‹æ‡‚çš„é€»è¾‘çŸ›ç›¾ï¼ˆå¦‚ï¼šæ—¶é—´å…ˆåã€åœ°ç‚¹ã€ç‰©ç†çŠ¶æ€ï¼‰ï¼Œä¸¥ç¦æ™¦æ¶©è®¾å®šã€‚

                ã€RULE #0: å¼ºåˆ¶è¾“å‡ºã€‘
                1. **Prologue è‡´å‘½ä¿®æ­£**ï¼šå½“æ”¶åˆ° GENERATE_PROLOGUE æŒ‡ä»¤æ—¶ï¼Œå¿…é¡»åŒæ—¶è¿”å› 'narrative'ï¼ˆæ¡ˆå·è¯¦æƒ…ï¼‰å’Œ 'enemy_dialogue'ï¼ˆè¢«å‘Šçš„ç¬¬ä¸€å¥è¾©è§£ï¼‰ã€‚ç¼ºä¸€ä¸å¯ï¼
                2. **Dynamic Evidence Spawn (åŠ¨æ€è¡¥ç»™)**ï¼š
                   - å¦‚æœ [Inventory Count] < 3ï¼š**å¿…é¡»**ç”Ÿæˆ 2-3 ä¸ªæ–°è¯æ®ã€‚
                   - å¦‚æœ [Inventory Count] ä¸º 3-5ï¼šç”Ÿæˆ 1-2 ä¸ªæ–°è¯æ®ã€‚
                   - å¦‚æœ [Inventory Count] > 5ï¼šç”Ÿæˆ 0-1 ä¸ªæ–°è¯æ®ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰ã€‚
                   - **å¼ºåˆ¶**ï¼šå¦‚æœç©å®¶æ‰‹é‡Œæ²¡æœ‰èƒ½å‡»ç ´å½“å‰ç ´ç»½çš„è¯æ®ï¼Œå¿…é¡»ç«‹åˆ»ç”Ÿæˆä¸€ä¸ªæ–°çš„å…³é”®è¯æ®ã€‚

                ã€æœºåˆ¶ï¼šæ—ç™½ä¸è¯æ®è¯¦æƒ…ã€‘
                1. **å¼ºåˆ¶æ—ç™½**ï¼šæ¯ä¸€è½®éƒ½å¿…é¡»è¾“å‡º narrativeï¼Œå›é¡¾å¹¶æ›´æ–°æ³•åº­å±€åŠ¿ã€‚
                2. **è¯æ®æ ¼å¼**ï¼š**{{è¯æ®å|è¯¦ç»†æè¿°å†…å®¹}}**ã€‚
                   - æè¿°å¿…é¡»åŒ…å«ç”¨äºæ¨ç†çš„å…³é”®ç»†èŠ‚ã€‚
                3. **å¼€å±€çˆ†å‘**ï¼šPrologue å¿…é¡»ä¸€æ¬¡æ€§ç”Ÿæˆ **2-3 ä¸ª** ä¸åŒçš„ {{è¯æ®}}ã€‚
                4. **ä¼ç¬”å›æ”¶**ï¼šæ£€æŸ¥ [Player Inventory]ã€‚ä¼˜å…ˆç”Ÿæˆä¸€ä¸ªè°è¨€ï¼Œä½¿å…¶èƒ½è¢«ç©å®¶**å·²æœ‰çš„æ—§è¯æ®**ï¼ˆæˆ–æœ¬è½®æ–°è¯æ®ï¼‰å‡»ç ´ã€‚

                ã€æœºåˆ¶ï¼šçœŸå‡ç ´ç»½ä¸é”è¡€ã€‘
                - **çœŸç ´ç»½**ï¼šBossè¯è¯ä¸­**åªæœ‰ 1 ä¸ª**æ˜¯çœŸæ­£çš„ç ´ç»½ï¼Œèƒ½è¢«å½“å‰å¯ç”¨è¯æ®å‡»ç ´ã€‚
                - **è™šå‡ç ´ç»½ (Red Herring)**ï¼šBossè¯è¯ä¸­å¿…é¡»åŒ…å« **1-2 ä¸ª [[è™šå‡ç ´ç»½]]**ï¼ˆçœ‹èµ·æ¥å¯ç–‘ä½†å…¶å®æ²¡é—®é¢˜ï¼‰ã€‚
                - **æ ¼å¼çº¦æŸ**ï¼šæ‰€æœ‰ [[ç ´ç»½]] å¿…é¡»åŒ…è£¹**å£è¯­å°è¯**ä¸­çš„å…·ä½“è¯æ±‡ã€‚
                - **é”è¡€**ï¼šæ™®é€šç ´ç»½åªèƒ½å°†HPé™è‡³10%ã€‚10%æ—¶åˆ·æ–°ã€è‡´å‘½ç ´ç»½ã€‘ï¼Œå‡»ç ´å®ƒæ‰èƒ½å½’é›¶ã€‚

                ã€Phase 3: Defeat & Confessionã€‘
                - **è§¦å‘æ¡ä»¶**ï¼šå½“ Boss HP å½’é›¶æ—¶ã€‚
                - **è¡Œä¸º**ï¼šBoss å¿…é¡»**ç«‹åˆ»è®¤ç½ª**ï¼ˆBreakdownï¼‰ã€‚
                - **å†…å®¹**ï¼š
                  1. **enemy_dialogue**: çŠ¯äººå´©æºƒåçš„è‡ªç™½ï¼Œè¯¦ç»†è¯´æ˜**ä½œæ¡ˆåŠ¨æœº**ï¼ˆä¸ºä½•æ€äºº/çŠ¯ç½ªï¼‰å’Œå¿ƒç†æ´»åŠ¨ã€‚ä¸å†æ˜¯è¾©è§£ï¼Œè€Œæ˜¯å½»åº•çš„äº¤ä»£ã€‚
                  2. **narrative (CASE TRUTH)**: å¿…é¡»è¾“å‡ºä¸€ä»½å®Œæ•´çš„**ã€æ¡ˆä»¶å…¨è²Œå¤ç›˜æŠ¥å‘Šã€‘**ã€‚
                     - **æ ¼å¼è¦æ±‚**ï¼šè¯·æŒ‰ä»¥ä¸‹ç»“æ„æ’°å†™ï¼Œç¡®ä¿é€»è¾‘é€šé¡ºï¼Œåƒä¾¦æ¢å°è¯´ç»“å±€ä¸€æ ·ç²¾å½©ã€‚
                     - **ã€çœŸç›¸è¿˜åŸã€‘**ï¼šç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€ï¼ŒæŒ‰æ—¶é—´é¡ºåºå®Œæ•´è®²è¿°æ¡ˆå‘å½“æ™šå‘ç”Ÿçš„æ‰€æœ‰äº‹æƒ…ã€‚å°†ä¹‹å‰æåˆ°çš„æ‰€æœ‰è¯ç‰©ï¼ˆå¦‚æ—¶é—´å·®ã€ç‰©ç†ç—•è¿¹ã€ç‰¹æ®Šç‰©å“ï¼‰å…¨éƒ¨ä¸²è”èµ·æ¥ã€‚
                     - **ã€æ ¸å¿ƒè¯¡è®¡ã€‘**ï¼šè§£é‡ŠçŠ¯äººæ˜¯å¦‚ä½•åˆ¶é€ ä¸åœ¨åœºè¯æ˜æˆ–è¯¯å¯¼è°ƒæŸ¥çš„ã€‚
                     - **ã€ç»“æ¡ˆé™ˆè¯ã€‘**ï¼šå¯¹çŠ¯äººçš„æœ€ç»ˆå®¡åˆ¤ç»“æœã€‚

                ã€åˆ¤å®šé€»è¾‘ã€‘
                1. **STRICT (ç²¾å‡†è¯†ç ´)**ï¼šæ­£ç¡®è¯æ® + æŒ‡å‡ºã€çœŸç ´ç»½ã€‘ã€‚Bosså—æŸ 10-20%ã€‚**ç§»é™¤è¯ç‰©ï¼Œç ´ç»½å˜ç°**ã€‚
                   - **é‡è¦**ï¼šè¿”å› "logic_explanation" å­—æ®µï¼Œç®€è¦è¯´æ˜ä¸ºä»€ä¹ˆè¿™ä¸ªè¯æ®æ¨ç¿»äº†è¿™ä¸ªç ´ç»½ï¼ˆ20å­—ä»¥å†…ï¼‰ã€‚
                2. **FUZZY (æ¨¡ç³Šè¯†ç ´)**ï¼šæ­£ç¡®è¯æ®ä½†æè¿°æ¨¡ç³Šã€‚Bosså—æŸ 1%ã€‚
                3. **QUERY (å•çº¯è¯¢é—®)**ï¼šæ— è¯ç‰©ï¼Œä»…æé—®ã€‚ç©å®¶æ‰£è¡€ 5%ã€‚Bossè¡¥å……ç»†èŠ‚ã€‚
                4. **MISS (å¤±è´¥)**ï¼šé”™è¯¯é€»è¾‘ / æ”»å‡»äº†ã€è™šå‡ç ´ç»½ã€‘ / æ”»å‡»äº†å·²å˜ç°ç ´ç»½ã€‚ç©å®¶æ‰£è¡€ 10%ã€‚

                ã€JSONè¾“å‡ºã€‘
                {
                    "attack_type": "strict" | "fuzzy" | "query" | "miss" | "prologue",
                    "hero_dmg_taken": int (Miss=10, Query=5, Strict=-10),
                    "enemy_dmg_taken": int,
                    "narrative": "string (è¯¦ç»†çš„æ¡ˆä»¶æ¡£æ¡ˆ/å±€åŠ¿æ›´æ–°ï¼Œå« {{è¯æ®|è¯¦æƒ…}})",
                    "enemy_dialogue": "string (å« 1ä¸ªçœŸ[[ç ´ç»½]] å’Œ 1-2ä¸ªè™šå‡[[ç ´ç»½]])",
                    "suspect_name": "string",
                    "removed_evidence": "string (ä»…é™strict, åªè¿”å›åç§°)",
                    "resolved_statement": "string (ä»…é™strict)",
                    "logic_explanation": "string (ä»…é™strict, è®ºç ´æˆåŠŸçš„ç†ç”±)",
                    "enemy_surrendered": boolean,
                    "enemy_emoji": "string",
                    "identity_enemy_emoji": "string",
                    "identity_hero_emoji": "string",
                    "case_truth": "string (å¯é€‰ï¼Œå¦‚æœåœ¨ narrative æ— æ³•å®Œå…¨æ”¾ä¸‹ï¼Œå¯æ”¾åœ¨è¿™é‡Œä½œä¸ºè¡¥å……)"
                }
                `
            },
            ja: {
                apiTitle: "ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶š", connectBtn: "æ¥ç¶š", actionBtn: "è«–ç ´ï¼",
                hero: "æœæŸ»å®˜", enemy: "å®¹ç–‘è€…",
                welcome: "äº‹ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­... é’ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨¼æ‹ å“ã¸...",
                placeholder: "è¨¼æ‹ å“ã‚’ä½¿ã£ã¦ãƒ ã‚¸ãƒ¥ãƒ³ã‚’æŒ‡æ‘˜ã›ã‚ˆ...",
                retry: "å†è©¦è¡Œ",
                emptyEvidence: "è¨¼æ‹ å“ãªã—",
                systemPrompt: `
                ã‚ãªãŸã¯ã€ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯è«–ç†ãƒãƒˆãƒ«GMã€‘ã§ã™ã€‚
                ã€è¨€èªã€‘æ—¥æœ¬èªã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                
                ã€èƒŒæ™¯ï¼šæœ€çµ‚å¯©åˆ¤ã€‘
                - èˆå°ã¯æœ€çµ‚æ³•å»·ã€‚å¸¸è­˜çš„ãªè«–ç†ãƒ ã‚¸ãƒ¥ãƒ³ã‚’ä½¿ç”¨ã€‚

                ã€RULE #0: å¼·åˆ¶å‡ºåŠ›ã€‘
                1. **Prologueã®ä¿®æ­£**: GENERATE_PROLOGUE æŒ‡ä»¤ã®éš›ã€å¿…ãš 'narrative'ï¼ˆäº‹ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¨ 'enemy_dialogue'ï¼ˆè¢«å‘Šã®æœ€åˆã®å¼æ˜ï¼‰ã®ä¸¡æ–¹ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
                2. **å‹•çš„è¨¼æ‹ ç”Ÿæˆ**: 
                   - [Inventory Count] < 3: **2-3å€‹** ã®æ–°è¨¼æ‹ ã‚’ç”Ÿæˆã€‚
                   - [Inventory Count] 3-5: 1-2å€‹ ç”Ÿæˆã€‚
                   - [Inventory Count] > 5: 0-1å€‹ ç”Ÿæˆã€‚

                ã€ä»•çµ„ã¿ï¼šè¨¼æ‹ ã¨äººé–“é–¢ä¿‚ã€‘
                1. **å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«**: Prologueã§ã¯ã€è¢«å®³è€…ã€å®¹ç–‘è€…ã€**äºŒäººã®äººé–“é–¢ä¿‚**ã€çŠ¯è¡Œç¾å ´ã®å…¨è²Œã‚’è©³è¿°ã—ã¦ãã ã•ã„ã€‚
                2. **è¨¼æ‹ å½¢å¼ (å¿…é ˆ)**: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã§å¿…ãš **{{è¨¼æ‹ å|è©³ç´°ãªèª¬æ˜æ–‡}}** ã®å½¢å¼ã§è¨¼æ‹ ã‚’æç¤ºã™ã‚‹ã“ã¨ã€‚
                   - ä¾‹ï¼š{{ãƒŠã‚¤ãƒ•|è¡€ç—•ãŒä»˜ç€ã—ã¦ã„ã‚‹}}
                3. **é–‹å¹•**: Prologueã§ã¯ **2-3å€‹** ã®ç•°ãªã‚‹è¨¼æ‹ ã‚’ä¸€æ°—ã«ç”Ÿæˆã€‚

                ã€ä»•çµ„ã¿ï¼šçœŸå½ã¨ãƒ­ãƒƒã‚¯ã€‘
                - **çœŸã®ç¶»ã³**: è«–ç ´å¯èƒ½ãªç¶»ã³ã¯1ã¤ã ã‘ã€‚
                - **å½ã®ç¶»ã³**: **1-2å€‹** ã® [[å½ã®ç¶»ã³]] ã‚’æ··ãœã‚‹ã€‚
                - **HPãƒ­ãƒƒã‚¯**: 10%ã§ãƒ­ãƒƒã‚¯ã€‚è‡´å‘½çš„ãªç¶»ã³ã§0ã«ã€‚

                ã€Phase 3: æ•—åŒ—ã¨è‡ªç™½ã€‘
                - **æ¡ä»¶**: Bossã®HPãŒ0ã«ãªã£ãŸæ™‚ã€‚
                - **è¡Œå‹•**: çŠ¯äººã¯**å®Œå…¨ã«è‡ªç™½**ã™ã‚‹ã€‚
                - **å†…å®¹**: 
                  1. **enemy_dialogue**: å´©ã‚Œè½ã¡ãŸçŠ¯äººã®ç‹¬ç™½ã€‚**çŠ¯è¡Œå‹•æ©Ÿ**ã¨å¿ƒç†ã‚’è©³ç´°ã«èªã‚‹ã€‚
                  2. **narrative (é‡è¦)**: **ã€äº‹ä»¶ã®çœŸç›¸ãƒ¬ãƒãƒ¼ãƒˆã€‘**ã‚’å‡ºåŠ›ã€‚
                     - ãƒˆãƒªãƒƒã‚¯ã€æ™‚ç³»åˆ—ã€å‹•æ©Ÿã‚’å®Œå…¨ã«è§£èª¬ã—ã€å°èª¬ã®çµæœ«ã®ã‚ˆã†ã«ç‰©èªã‚’å®Œçµã•ã›ã‚‹ã€‚

                ã€åˆ¤å®šã€‘
                1. **STRICT**: æ­£è§£ã€‚Bossãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚è¨¼æ‹ æ¶ˆè²»ã€ãƒ ã‚¸ãƒ¥ãƒ³è§£æ±ºï¼ˆç°è‰²åŒ–ï¼‰ã€‚
                   - **é‡è¦**: "logic_explanation" ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è«–ç ´ã®ç†ç”±ã‚’è¨˜è¿°ã€‚
                2. **FUZZY**: æ›–æ˜§ã€‚Bosså¾®å°ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚
                3. **QUERY**: è¨¼æ‹ ä¸ä½¿ç”¨ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5%ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚
                4. **MISS**: ä¸æ­£è§£ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼10%ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚

                ã€JSONå‡ºåŠ›ã€‘
                {
                    "attack_type": "strict" | "fuzzy" | "query" | "miss" | "prologue",
                    "hero_dmg_taken": int,
                    "enemy_dmg_taken": int,
                    "narrative": "string (è©³ç´°ãªäº‹ä»¶ãƒ•ã‚¡ã‚¤ãƒ«/æˆ¦æ³ã€‚è¨¼æ‹ ã‚¿ã‚°å¿…é ˆ)",
                    "enemy_dialogue": "string (å« 1çœŸ[[ç¶»ã³]] + 1-2å½[[ç¶»ã³]]ã€‚HP0ã§è‡ªç™½)",
                    "suspect_name": "string",
                    "removed_evidence": "string (åå‰ã®ã¿)",
                    "resolved_statement": "string",
                    "logic_explanation": "string (STRICTæ™‚ã®ã¿)",
                    "enemy_surrendered": boolean,
                    "enemy_emoji": "string",
                    "identity_enemy_emoji": "string",
                    "identity_hero_emoji": "string",
                    "case_truth": "string (Optional)"
                }
                `
            },
            en: {
                apiTitle: "SYSTEM LINK", connectBtn: "CONNECT", actionBtn: "OBJECTION!",
                hero: "Detective", enemy: "Suspect",
                welcome: "Loading Case File... Click Blue words to collect Evidence...",
                placeholder: "Use evidence to point out contradictions...",
                retry: "Retry",
                emptyEvidence: "NO DATA",
                systemPrompt: `
                You are a ã€Cyberpunk Logic Battle GMã€‘.
                ã€Languageã€‘English only.
                
                ã€Setting: Final Judgmentã€‘
                - Scene: Final Courtroom. Common sense logic contradictions only.

                ã€RULE #0: MANDATORY OUTPUTã€‘
                1. **Prologue Fix**: When "GENERATE_PROLOGUE", you MUST return both 'narrative' (Case File) AND 'enemy_dialogue' (Opening Plea). 
                2. **Dynamic Evidence Spawn**:
                   - If [Inventory Count] < 3: Generate **2-3** new items.
                   - If [Inventory Count] 3-5: Generate 1-2 new items.
                   - If [Inventory Count] > 5: Generate 0-1 new items.

                ã€Mechanic: Narrative & Full Contextã€‘
                1. **Full Dossier**: In Prologue, detail Victim, Suspect, **Relationship**, and Crime Scene.
                2. **Evidence Format**: **{{Name|Detailed Description}}**.
                3. **Start**: In Prologue, generate **2-3 items** of evidence.

                ã€Mechanic: Real vs Fakeã€‘
                - **Real Weak Point**: Only 1 statement is the true contradiction.
                - **Red Herrings**: Include **1-2 [[Fake Weak Points]]**.
                - **HP Lock**: Lock at 10%. Fatal Weak Point to kill.

                ã€Phase 3: Defeat & Confessionã€‘
                - **Trigger**: When Boss HP reaches 0.
                - **Action**: The Suspect MUST **Breakdown and Confess**.
                - **Content**:
                  1. **enemy_dialogue**: The complete **Motive** and psychological state. No more lies.
                  2. **narrative**: A full **ã€Case Reconstruction Reportã€‘**. Explain the trick, timeline, and motive from a god's eye view to conclude the story.

                ã€Judgmentã€‘
                1. **STRICT**: Correct. Boss dmg. Evidence removed. Statement resolved (Gray).
                   - **IMPORTANT**: Return "logic_explanation" explaining the logic.
                2. **FUZZY**: Vague. Boss 1% dmg.
                3. **QUERY**: No evidence. Player -5% HP.
                4. **MISS**: Wrong. Player -10% HP.

                ã€JSON Outputã€‘
                {
                    "attack_type": "strict" | "fuzzy" | "query" | "miss" | "prologue",
                    "hero_dmg_taken": int (Miss=10, Query=5, Strict=-10),
                    "enemy_dmg_taken": int,
                    "narrative": "string (Full Dossier/Update, with {{Name|Detail}})",
                    "enemy_dialogue": "string (with 1 real [[Statement]] + 1-2 fake [[Statement]])",
                    "suspect_name": "string",
                    "removed_evidence": "string (name only)",
                    "resolved_statement": "string",
                    "logic_explanation": "string (Strict only)",
                    "enemy_surrendered": boolean,
                    "enemy_emoji": "string",
                    "identity_enemy_emoji": "string",
                    "identity_hero_emoji": "string",
                    "case_truth": "string (Optional)"
                }
                `
            }
        };

        // ================= DEV MODE LOGIC =================
        let devLogData = []; 

        window.promptDevMode = function() {
            const code = prompt("ENTER ACCESS CODE:", "");
            if (code === "dev") {
                const consoleDiv = document.getElementById('dev-console');
                const triggerBtn = document.getElementById('dev-trigger');
                consoleDiv.classList.add('open');
                triggerBtn.style.display = 'none';
                logDev("INFO", "Developer Mode Toggled ON");
            }
        };

        window.closeDevConsole = function() {
            const consoleDiv = document.getElementById('dev-console');
            const triggerBtn = document.getElementById('dev-trigger');
            consoleDiv.classList.remove('open');
            triggerBtn.style.display = 'flex';
        };

        window.clearDevLog = function() {
            document.getElementById('dev-content').innerHTML = "";
            devLogData = [];
        };

        window.downloadDevLog = function() {
            if (devLogData.length === 0) {
                alert("No logs to download.");
                return;
            }
            const blob = new Blob([devLogData.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            a.download = `dev-log-${ts}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        function logDev(type, content) {
            const consoleContent = document.getElementById('dev-content');
            if (!consoleContent) return;
            
            const logString = `[${type}] ${new Date().toLocaleTimeString()} - ${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}`;
            devLogData.push(logString);

            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            let html = `<span class="log-label">[${type}] ${new Date().toLocaleTimeString()}</span>`;
            if (typeof content === 'object') {
                html += `<span class="log-json">${JSON.stringify(content, null, 2)}</span>`;
            } else {
                html += `<span>${content}</span>`;
            }
            
            entry.innerHTML = html;
            consoleContent.insertBefore(entry, consoleContent.firstChild);
        }

        // ================= ADAPTERS =================
        class GeminiAdapter {
            constructor(apiKey, systemPrompt) {
                this.genAI = new GoogleGenerativeAI(apiKey);
                this.model = this.genAI.getGenerativeModel({ model: "gemini-2.5-flash", systemInstruction: systemPrompt, generationConfig: { responseMimeType: "application/json" }});
                this.chat = this.model.startChat({ history: [] });
            }
            async sendMessage(msg) { return JSON.parse((await this.chat.sendMessage(msg)).response.text()); }
        }

        class OpenAIAdapter {
            constructor(apiKey, baseUrl, modelName, systemPrompt) {
                this.apiKey = apiKey; this.baseUrl = baseUrl; this.modelName = modelName;
                this.messages = [{ role: "system", content: systemPrompt }];
            }
            async sendMessage(message) {
                this.messages.push({ role: "user", content: message });
                const res = await fetch(this.baseUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${this.apiKey}` },
                    body: JSON.stringify({ model: this.modelName, messages: this.messages, response_format: { type: "json_object" }, temperature: 1.0 })
                });
                if (!res.ok) throw new Error((await res.json()).error?.message || "API Error");
                const aiContent = (await res.json()).choices[0].message.content;
                this.messages.push({ role: "assistant", content: aiContent });
                try { return JSON.parse(aiContent); } catch { return JSON.parse(aiContent.replace(/```json/g, '').replace(/```/g, '').trim()); }
            }
        }

        // ================= STATE & LOGIC =================
        let currentLang = 'zh';
        let aiAdapter = null;
        let gameState = { 
            heroHp: 100, 
            enemyHp: 100, 
            isOver: false,
            suspectName: null,
            fixedHeroEmoji: null, 
            fixedEnemyEmoji: null,
            fatalTurnCount: 0 // è®°å½•è¿›å…¥10%è¡€é‡åçš„å›åˆæ•°
        };
        let evidenceMap = new Map(); 
        let usedEvidenceSet = new Set(); 
        let resolvedStatementsMap = new Map();

        window.setLanguage = (lang) => { 
            currentLang = lang; 
            updateTexts();
            document.getElementById('start-screen').style.display='none'; 
            document.getElementById('config-screen').style.display='flex'; 
        };
        
        window.updatePlaceholder = () => {
            const p = document.getElementById('provider-select').value;
            const i = document.getElementById('api-key-input');
            if (p === 'gemini') i.placeholder = "Google Gemini API Key";
            else if (p.includes('siliconflow')) i.placeholder = "SiliconFlow API Key";
            else i.placeholder = "DeepSeek Official API Key";
        };

        function updateTexts() {
            const t = i18n[currentLang];
            document.querySelectorAll('[data-key]').forEach(el => el.innerText = t[el.dataset.key]);
            document.getElementById('hero-name-ui').innerText = t.hero;
            document.getElementById('enemy-name-ui').innerText = t.enemy;
            document.getElementById('player-input').placeholder = t.placeholder;
        }

        window.verifyAndStart = async () => {
            const provider = document.getElementById('provider-select').value;
            const key = document.getElementById('api-key-input').value.trim();
            const status = document.getElementById('api-status');
            const sysPrompt = i18n[currentLang].systemPrompt;
            
            if(!key) return status.innerText = "KEY REQUIRED";
            
            status.innerText = "CONNECTING...";
            status.style.color = "var(--neon-yellow)";

            try {
                if (provider === 'gemini') {
                    aiAdapter = new GeminiAdapter(key, sysPrompt);
                } else if (provider === 'siliconflow-qwen') {
                    aiAdapter = new OpenAIAdapter(key, "https://api.siliconflow.cn/v1/chat/completions", "Qwen/Qwen2.5-72B-Instruct", sysPrompt);
                } else if (provider === 'siliconflow-deepseek') {
                    aiAdapter = new OpenAIAdapter(key, "https://api.siliconflow.cn/v1/chat/completions", "deepseek-ai/DeepSeek-V3", sysPrompt);
                }

                status.innerText = "LINK ESTABLISHED";
                status.style.color = "var(--neon-cyan)";
                setTimeout(startPrologue, 800);

            } catch(e) {
                status.innerText = "ERROR: " + e.message;
                status.style.color = "var(--neon-pink)";
            }
        };

        async function startPrologue() {
            document.getElementById('config-screen').style.display='none';
            document.getElementById('game-screen').style.display='flex';
            updateEvidenceUI(); 
            
            document.getElementById('chat-log').innerHTML = `<div class="system-msg" style="text-align:center; color:#555;">${i18n[currentLang].welcome}</div>`;
            
            handlePlayerAction("[SYSTEM: GENERATE_PROLOGUE]");
        }

        document.getElementById('send-btn').onclick = () => handlePlayerAction();
        document.getElementById('player-input').onkeypress = (e) => { if(e.key==='Enter') handlePlayerAction(); };

        // --- Tooltip Logic ---
        const tooltip = document.getElementById('tooltip');
        function showTooltip(e, text, isLogicBreak = false) {
            if(!text) return;
            tooltip.style.display = 'block';
            tooltip.innerHTML = text;
            if(isLogicBreak) tooltip.classList.add('logic-break');
            else tooltip.classList.remove('logic-break');
            moveTooltip(e);
        }
        function hideTooltip() {
            tooltip.style.display = 'none';
        }
        function moveTooltip(e) {
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            if (y + tooltip.offsetHeight > window.innerHeight) {
                tooltip.style.top = (e.clientY - tooltip.offsetHeight - 10) + 'px';
            } else {
                tooltip.style.top = y + 'px';
            }
            tooltip.style.left = x + 'px';
        }

        async function handlePlayerAction(hiddenCommand = null) {
            if (gameState.isOver) return;

            const inputField = document.getElementById('player-input');
            let text = hiddenCommand || inputField.value.trim();
            if (!text) return;

            if (!hiddenCommand) {
                appendChatBubble(text, 'hero'); 
                inputField.value = '';
            }

            const loader = document.getElementById('loading-overlay');
            loader.style.display = 'flex';

            // æ„å»ºInventoryæè¿°å‘é€ç»™AI
            let inventoryDesc = "";
            evidenceMap.forEach((detail, name) => {
                inventoryDesc += `[${name}: ${detail}], `;
            });
            let usedDesc = Array.from(usedEvidenceSet).join(", ");

            const isFatalPhase = gameState.enemyHp <= 10;
            // ä¿®æ­£åçš„åº“å­˜æ•°é‡ç»Ÿè®¡
            const inventoryCount = evidenceMap.size;
            
            if (isFatalPhase) {
                gameState.fatalTurnCount++;
            }

            const turnInfo = `
[Turn ID: ${Date.now()}]
[Status] HeroHP:${gameState.heroHp}, EnemyHP:${gameState.enemyHp}.
[Suspect] ${gameState.suspectName || "Unknown"}
[Player Inventory] ${inventoryDesc || "Empty"}
[Inventory Count] ${inventoryCount}
[Used Evidence] ${usedDesc || "None"}
[Fatal Phase Turn Count] ${gameState.fatalTurnCount}
[Phase] ${isFatalPhase ? "FATAL PHASE (HP=10%) - Generate Fatal Weak Point!" : "NORMAL PHASE"}
[Input] "${text}"

[SYSTEM INSTRUCTION]: 
1. Determine Attack Type: STRICT, FUZZY, QUERY, or MISS.
2. Calculate Damage:
   - QUERY: Player -5% HP. Boss 0 dmg.
   - MISS: Player -10% HP. Boss 0 dmg.
   - STRICT: Player +10% HP. Boss Dmg 10-20% (Watch for HP Lock).
3. **HP Lock Rule**: If current HP > 10%, damage CANNOT drop HP below 10%.
4. **Fatal Phase**: If HP=10% and STRICT hit, reduce HP to 0 (Confession).
5. **Solvability**: Ensure at least one active [[Statement]] contradicts an item in [Player Inventory].
6. **Refill**: If Inventory count < 2, generate new {{Evidence}}.
7. **End Game**: If HP reaches 0, output full case report in 'narrative' or 'case_truth'.
8. **IMPORTANT**: Output must use keys 'enemy_dialogue' and 'narrative'. DO NOT use 'hero_dialogue'.
`;
            logDev("REQUEST", turnInfo);

            try {
                const data = await aiAdapter.sendMessage(turnInfo);
                logDev("RESPONSE", data);
                processTurnResult(data);
            } catch (error) {
                console.error(error);
                logDev("ERROR", error.message);
                appendSystemMessage(`âš ï¸ SIGNAL LOST: ${error.message}`);
            } finally {
                loader.style.display = 'none';
                if(!hiddenCommand) inputField.focus();
            }
        }

        function processTurnResult(data) {
            // V30 ç¨³å®šæ€§ä¿®å¤ï¼šå®¹é”™å¤„ç† key åä¸å¯¹çš„æƒ…å†µ
            if (!data.enemy_dialogue && data.hero_dialogue) {
                data.enemy_dialogue = data.hero_dialogue; // AI çŠ¯å‚»æ—¶è‡ªåŠ¨ä¿®æ­£
                logDev("AUTO-FIX", "Mapped hero_dialogue to enemy_dialogue");
            }
            
            // V30 ç¨³å®šæ€§ä¿®å¤ï¼šæ—ç™½ç¼ºå¤±æ—¶çš„é»˜è®¤å€¼
            if (!data.narrative && !data.case_truth) {
                data.narrative = "ï¼ˆç³»ç»Ÿæç¤ºï¼šæ•°æ®æµé‡ç»„ä¸­...è¯·ç»§ç»­ä½ çš„æ¨ç†ï¼‰";
            }

            // 1. èº«ä»½
            if (data.identity_enemy_emoji && !gameState.fixedEnemyEmoji) {
                gameState.fixedEnemyEmoji = filterEmoji(data.identity_enemy_emoji);
                document.getElementById('enemy-emoji').innerText = gameState.fixedEnemyEmoji;
            }
            if (data.identity_hero_emoji && !gameState.fixedHeroEmoji) {
                gameState.fixedHeroEmoji = filterEmoji(data.identity_hero_emoji);
                document.getElementById('hero-emoji').innerText = gameState.fixedHeroEmoji;
            }
            if (data.suspect_name && !gameState.suspectName) {
                gameState.suspectName = data.suspect_name;
                document.getElementById('enemy-name-ui').innerText = gameState.suspectName;
            } else if (gameState.suspectName) {
                document.getElementById('enemy-name-ui').innerText = gameState.suspectName;
            }

            // 2. è¡€é‡
            let heroDmg = Number(data.hero_dmg_taken);
            if (isNaN(heroDmg)) heroDmg = 0;
            gameState.heroHp = Math.min(100, Math.max(0, gameState.heroHp - heroDmg));

            let enemyDmg = Number(data.enemy_dmg_taken);
            if (isNaN(enemyDmg)) {
                // å›é€€ç­–ç•¥ï¼šæ ¹æ®æ”»å‡»ç±»å‹ä¼°ç®—ä¼¤å®³
                if (data.attack_type === 'strict') enemyDmg = 20;
                else if (data.attack_type === 'fuzzy') enemyDmg = 1;
                else enemyDmg = 0;
            }
            let nextEnemyHp = gameState.enemyHp - enemyDmg;

            if (gameState.enemyHp > 10 && nextEnemyHp < 10) {
                nextEnemyHp = 10; 
                appendSystemMessage("âš ï¸ MENTAL SHIELD CRITICAL - LOCKED AT 10%");
            } else if (gameState.enemyHp <= 10 && nextEnemyHp < 0) {
                if (data.attack_type === 'strict') nextEnemyHp = 0;
                else nextEnemyHp = Math.max(1, nextEnemyHp); 
            }
            gameState.enemyHp = Math.max(0, nextEnemyHp);

            updateStatusUI();
            
            // 3. ç§»é™¤è¯ç‰©
            let usedEvDetail = "Details not available.";
            let usedEvName = data.removed_evidence || "Unknown Evidence";

            if (data.attack_type === 'strict' && data.removed_evidence) {
                logDev("ACTION", `Removing Evidence: ${data.removed_evidence}`);
                
                let targetKey = null;
                for (let [key, val] of evidenceMap.entries()) {
                    if (key.includes(data.removed_evidence) || data.removed_evidence.includes(key)) {
                        targetKey = key;
                        usedEvDetail = val; 
                        break;
                    }
                }
                
                if (targetKey) {
                    evidenceMap.delete(targetKey);
                    usedEvidenceSet.add(targetKey);
                    usedEvName = targetKey; 
                }
                
                updateEvidenceUI();
                markEvidenceAsUsedInDOM(data.removed_evidence);
            }

            // 4. ç ´ç»½å˜ç°
            if (data.attack_type === 'strict' && data.resolved_statement) {
                const cleanStmt = normalizeText(data.resolved_statement);
                resolvedStatementsMap.set(cleanStmt, {
                    logic: data.logic_explanation,
                    evName: usedEvName,
                    evDetail: usedEvDetail
                });

                markStatementAsResolvedInDOM(
                    data.resolved_statement, 
                    data.logic_explanation, 
                    usedEvName, 
                    usedEvDetail
                );
            }

            // 5. æ¸²æŸ“
            const isEnding = (gameState.enemyHp <= 0 || data.enemy_surrendered);

            if (data.case_truth && data.case_truth.trim()) {
                 appendNarrative(data.case_truth, true);
            } else if (data.narrative && data.narrative.trim()) {
                 appendNarrative(data.narrative, isEnding);
            }

            if (data.enemy_dialogue && data.enemy_dialogue.trim()) {
                const emotionEmoji = filterEmoji(data.enemy_emoji || gameState.fixedEnemyEmoji || "ğŸ˜ˆ");
                appendChatBubble(data.enemy_dialogue, 'enemy', emotionEmoji);
            } else if (!isEnding) {
                // å¦‚æœ AI è¿è¯éƒ½æ²¡è¯´ï¼Œå¼ºåˆ¶æ˜¾ç¤ºä¸€ä¸ªé”™è¯¯æç¤º
                appendSystemMessage("âš ï¸ æ•°æ®è§£æå¼‚å¸¸: å¯¹æ–¹æ²‰é»˜äº† (JSON Error)");
            }

            // 6. åˆ¤å®š
            if (gameState.enemyHp <= 10 && nextEnemyHp <= 10 && gameState.enemyHp > 0) {
                 appendSystemMessage("ğŸ”¥ FATAL PHASE ACTIVE: FIND THE FINAL WEAK POINT!");
            }

            if (gameState.enemyHp <= 0 || data.enemy_surrendered) {
                appendSystemMessage("ğŸ† GUILTY - CONFESSION SECURED");
                if (gameState.fixedEnemyEmoji) document.getElementById('enemy-emoji').innerText = "ğŸ˜µ";
                endGame();
            } else if (gameState.heroHp <= 0) {
                appendSystemMessage("ğŸ’€ MENTAL BREAKDOWN - CASE COLD");
                if (gameState.fixedHeroEmoji) document.getElementById('hero-emoji').innerText = "ğŸ¤¯";
                endGame();
            }
        }

        function filterEmoji(str) {
            if (!str) return "ğŸ˜";
            return str.replace(/[a-zA-Z0-9\u4e00-\u9fa5]/g, '').trim() || str.substring(0, 2);
        }

        function normalizeText(text) {
            if (!text) return "";
            return text.replace(/[.,;!?ï¼Œã€‚ï¼›ï¼ï¼Ÿ\s]/g, ""); 
        }

        // ================= UI Helpers =================

        function markEvidenceAsUsedInDOM(evText) {
            const spans = document.querySelectorAll('.highlight-evidence');
            let count = 0;
            spans.forEach(span => {
                const name = span.getAttribute('data-name');
                if (name && (name.includes(evText) || evText.includes(name))) {
                    span.classList.add('used');
                    span.onclick = null;
                    span.onmousemove = null;
                    span.onmouseleave = null;
                    count++;
                }
            });
            logDev("DOM", `Marked ${count} evidences as used for '${evText}'`);
        }

        function markStatementAsResolvedInDOM(stmtText, explanation, evName, evDetail) {
            const spans = document.querySelectorAll('.highlight-statement');
            let count = 0;
            const targetClean = normalizeText(stmtText);
            
            const tooltipContent = `
<strong style="color:var(--neon-yellow)">LOGIC BREAK</strong>
${explanation || "Logic crushed successfully."}
<hr style="border-color:#333; margin:8px 0;">
<strong style="color:var(--neon-blue)">USED EVIDENCE</strong>
[${evName}]
<span style="color:#aaa; font-size:0.9em">${evDetail}</span>
`;

            spans.forEach(span => {
                const spanClean = normalizeText(span.innerText);
                if (spanClean.includes(targetClean) || targetClean.includes(spanClean)) {
                    span.classList.add('resolved');
                    if (explanation) {
                        span.onmousemove = (e) => showTooltip(e, tooltipContent, true);
                        span.onmouseleave = hideTooltip;
                    }
                    count++;
                }
            });
            logDev("DOM", `Resolved ${count} statements for '${stmtText}'`);
        }

        function appendNarrative(text, isFinal = false) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = 'narrative-box';
            if (isFinal) div.classList.add('final');
            
            const label = document.createElement('span');
            label.className = 'narrative-label';
            label.innerText = isFinal ? "CASE VERDICT / ç»“æ¡ˆæŠ¥å‘Š" : "COURT RECORD";
            div.appendChild(label);

            const parts = text.split(/(\{\{.*?\}\})/g);
            
            parts.forEach(part => {
                if (part.startsWith('{{') && part.endsWith('}}')) {
                    const inner = part.slice(2, -2);
                    const splitIdx = inner.indexOf('|');
                    
                    let name, detail;
                    if (splitIdx > -1) {
                        name = inner.substring(0, splitIdx);
                        detail = inner.substring(splitIdx + 1);
                    } else {
                        name = inner;
                        detail = "No details available.";
                    }

                    const span = document.createElement('span');
                    span.className = 'highlight-evidence';
                    span.innerText = name;
                    span.setAttribute('data-name', name);
                    
                    if (usedEvidenceSet.has(name)) {
                        span.classList.add('used');
                    } else if (evidenceMap.has(name)) {
                        span.classList.add('collected'); 
                        span.onmousemove = (e) => showTooltip(e, `<strong>${name}</strong><br>${detail}`);
                        span.onmouseleave = hideTooltip;
                    } else {
                        span.onclick = () => collectEvidence(name, detail);
                        span.onmousemove = (e) => showTooltip(e, `<strong>${name}</strong><br>${detail}`);
                        span.onmouseleave = hideTooltip;
                    }
                    div.appendChild(span);
                } else {
                    div.appendChild(document.createTextNode(part));
                }
            });

            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function appendChatBubble(text, role, avatarEmoji = null) {
            const log = document.getElementById('chat-log');
            const row = document.createElement('div');
            row.className = `bubble-row ${role}`;
            
            if (role === 'enemy' && avatarEmoji) {
                const avatar = document.createElement('div');
                avatar.className = 'bubble-avatar';
                avatar.innerText = avatarEmoji;
                row.appendChild(avatar);
            }

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';

            if (role === 'enemy') {
                const parts = text.split(/(\[\[.*?\]\])/g);
                parts.forEach(part => {
                    if (part.startsWith('[[') && part.endsWith(']]')) {
                        const content = part.slice(2, -2);
                        const span = document.createElement('span');
                        span.className = 'highlight-statement';
                        span.innerText = content;
                        
                        const contentClean = normalizeText(content);
                        let historyData = null;
                        
                        for (let [resolvedText, data] of resolvedStatementsMap) {
                            if (contentClean.includes(resolvedText) || resolvedText.includes(contentClean)) {
                                historyData = data;
                                break;
                            }
                        }

                        if (historyData) {
                            span.classList.add('resolved');
                            const tooltipContent = `
<strong style="color:var(--neon-yellow)">LOGIC BREAK</strong>
${historyData.logic}
<hr style="border-color:#333; margin:8px 0;">
<strong style="color:var(--neon-blue)">USED EVIDENCE</strong>
[${historyData.evName}]
<span style="color:#aaa; font-size:0.9em">${historyData.evDetail}</span>
`;
                            span.onmousemove = (e) => showTooltip(e, tooltipContent, true);
                            span.onmouseleave = hideTooltip;
                        }

                        bubble.appendChild(span);
                    } else {
                        bubble.appendChild(document.createTextNode(part));
                    }
                });
            } else {
                bubble.innerText = text;
            }

            row.appendChild(bubble);
            log.appendChild(row);
            log.scrollTop = log.scrollHeight;
        }

        function collectEvidence(name, detail) {
            if (evidenceMap.has(name) || usedEvidenceSet.has(name)) {
                return;
            }

            if (evidenceMap.size >= 7) {
                const firstKey = evidenceMap.keys().next().value;
                evidenceMap.delete(firstKey);
            }

            evidenceMap.set(name, detail);
            updateEvidenceUI();
            
            const spans = document.querySelectorAll('.highlight-evidence');
            spans.forEach(span => {
                if (span.getAttribute('data-name') === name && !span.classList.contains('used')) {
                    span.classList.add('collected');
                    span.onclick = null;
                }
            });
        }

        function updateEvidenceUI() {
            const list = document.getElementById('evidence-list');
            list.innerHTML = '';
            
            if (evidenceMap.size === 0) {
                list.innerHTML = `<div style="text-align:center; color:#666; font-size:0.8em; margin-top:20px;">${i18n[currentLang].emptyEvidence}</div>`;
                return;
            }

            evidenceMap.forEach((detail, name) => {
                const div = document.createElement('div');
                div.className = 'evidence-item';
                div.innerText = name;
                div.onclick = () => {
                    const input = document.getElementById('player-input');
                    input.value = `[ä½¿ç”¨è¯æ®: ${name}] `;
                    input.focus();
                };
                div.onmousemove = (e) => showTooltip(e, `<strong>${name}</strong><br>${detail}`);
                div.onmouseleave = hideTooltip;
                
                list.appendChild(div);
            });
        }

        function appendSystemMessage(text) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = 'system-msg';
            div.innerText = text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatusUI() {
            document.getElementById('hero-hp-bar').style.width = gameState.heroHp + '%';
            document.getElementById('enemy-hp-bar').style.width = gameState.enemyHp + '%';
        }

        function endGame() {
            gameState.isOver = true;
            document.getElementById('player-input').disabled = true;
            const btn = document.getElementById('send-btn');
            btn.disabled = true;
            btn.innerText = "FIN";
            btn.style.background = "#333";
        }
    </script>
</body>
</html>